<html>
<head>
  <script src="libs/RGraph.common.core.js"></script>
  <script src="libs/RGraph.hprogress.js"></script>
  <script src="libs/RGraph.hbar.js"></script>
  <link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body onload="init()">

<script>

var showdetails = false;

function configure() {
  properties = new Object();
  properties.url = "options.html"
  chrome.tabs.create(properties, null);
}

function init() {
  var limit = localStorage['limit'];
  var totalusage = localStorage['totalusage'];
  var unit = localStorage['unit'];
  var dailyusage = eval(localStorage['dailyusage']);
  var firstday = localStorage['firstday'];
  var lastday = localStorage['lastday'];
  var username = localStorage['username'];
  var password = localStorage['password'];
  
  if (!username || !password) {
    document.getElementById("h_title").innerHTML = 'No credentials found<br/><button onclick="configure()">Configure</button>';
    document.getElementById("alldata").setAttribute("class", "hidden");
    return;
  }

  if (!totalusage) {
    document.getElementById("h_title").innerHTML = 'Invalid data<br/>Are your credentials correct?<br/><button onclick="configure()">Configure</button>';
    document.getElementById("alldata").setAttribute("class", "hidden");
    return;
  }


  document.getElementById("h_title").innerHTML = 'Telemeter status for ' + username;
  document.getElementById("period").innerHTML = 'period: ' + firstday.substr(0,5) + ' to ' + lastday.substr(0,5);
  document.getElementById("quota").innerHTML = 'free: ' + formatQuota(limit-totalusage) + ' - used: ' + formatQuota(totalusage) + ' - limit: ' + formatQuota(limit);

  var percentage = (totalusage/limit)*100; 
  drawGeneralProgress(percentage);

  drawDetail(dailyusage, unit);
}

function drawGeneralProgress(percentage) {
  var progress = new RGraph.HProgress('canvas_progress', percentage, 100);
  progress.Set('chart.tickmarks', true);
  progress.Set('chart.margin', 3);
  progress.Set('chart.tickmarks.inner', true);
  progress.Set('chart.label.inner', true);
  progress.Set('chart.min', 0);
  progress.Set('chart.units.post', '%');
  progress.Draw();
}

function drawDetail(dailyusage, unit) {
  var values = new Array();
  var dates = new Array();

  for (i = 0; i < dailyusage.length; i++) {
    var d = dailyusage[i];
    values[i] = parseInt(dailyusage[i].usage);
    dates[i] = dailyusage[i].day.substr(0, 5);
    console.log(values[i] + ' / ' + dates[i]);
  }

  var hbar = new RGraph.HBar('canvas_detail', values); 
  hbar.Set('chart.title.xaxis', 'Usage in ' + unit);
  hbar.Set('chart.title.yaxis', 'Date');
  hbar.Set('chart.background.barcolor1', '#ccc');
  hbar.Set('chart.background.barcolor2', '#ccc');
  hbar.Set('chart.background.grid.autofit', true);
  hbar.Set('chart.units.post', ' ' + unit);
  hbar.Set('chart.text.style', '#333');
  hbar.Set('chart.colors', ['red']);
  hbar.Set('chart.labels', dates);
  hbar.Set('chart.vmargin', 2);
  hbar.Set('chart.gutter', 25);
  hbar.Set('chart.labels.above', true);
  hbar.Draw();
}

function showmore() {
  showdetails = !showdetails; 
  var span = document.getElementById("seemore");
  var link = document.getElementById("showmorelink");
  
  if (showdetails) {
    span.setAttribute("class", "shown");
    link.innerHTML = "hide daily usage";
  } else {
    span.setAttribute("class", "hidden");
    link.innerHTML = "show  daily usage";
  }
}

function report() {
  obj = new Object();
  obj.url = "https://github.com/vbsteven/Telenet-Telemeter-Chrome-extension/issues";
  chrome.tabs.create(obj);
}

function formatQuota(quota) {
  if (true) {
    temp = quota/1024;
    return temp.toFixed(2) + " GB";
  }

  // no change needed, return
  return quota + " MB";
}


</script>


<center><h1 id="h_title">Telemeter stats</h1>
<span id="alldata">
  <canvas id="canvas_progress" width="400px" height="75px"></canvas>
  <p class="data" id="quota"></p>
  <p class="data" id="period"></p>
  <p class="data" ><a href="#" id="showmorelink" onclick="showmore()">show daily usage</a></p>
  <span id="seemore" class="hidden">
    <center><h1>Detailed usage per day</h1></center>
    <canvas id="canvas_detail" width="450px" height="600px"></canvas>
  </span>
</span>
<p class="small"><a onclick="report()" href="">Report a bug or suggest a feature</a></p>
</center>
</body>
